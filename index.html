<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Diagrama Hombre-M√°quina ‚Äî Avanzado</title>
<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --muted:#6c757d;
    --accent:#0d6efd; --danger:#dc3545;
    --border:#dee2e6;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:#222}
  .app{max-width:1200px;margin:18px auto;padding:18px;background:var(--card);border-radius:10px;box-shadow:0 4px 22px rgba(0,0,0,0.06)}
  h1{margin:0 0 12px}
  .row{display:flex;gap:12px;align-items:flex-start}
  .col{flex:1}
  .panel{background:#fff;border:1px solid var(--border);padding:12px;border-radius:8px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  input,select,button{font-size:14px}
  button{cursor:pointer;padding:8px 10px;border-radius:6px;border:none;color:#fff}
  .btn-primary{background:var(--accent)}
  .btn-danger{background:var(--danger)}
  .btn-secondary{background:var(--muted); color:#fff}
  #acciones-disponibles{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .accion-wrapper{position:relative;display:inline-block;}
  .btn-delete-action{
    position:absolute; top:-8px; right:-8px; background:var(--danger); color:white;
    border-radius:50%; width:18px; height:18px; font-size:12px; line-height:18px;
    text-align:center; cursor:pointer; border:1px solid white;
  }

  /* tabla */
  .tabla-contenedor{overflow:auto;border:1px solid var(--border);border-radius:6px;margin-top:12px;position:relative}
  table{border-collapse:collapse;width:100%;transform-origin:top left}
  thead th{position:sticky;top:0;background:#f1f3f5;padding:8px;border:1px solid var(--border)}
  td,th{min-width:72px;padding:6px;text-align:center;border:1px solid var(--border)}
  tbody td:first-child{background:#fafafa;font-weight:600}
  .celda-inactiva{background-image:repeating-linear-gradient(45deg, rgba(220,53,69,0.06), rgba(220,53,69,0.06) 8px, transparent 8px, transparent 16px)}
  /* tooltip */
  #tooltip{position:fixed;background:#222;color:#fff;padding:6px 8px;border-radius:6px;pointer-events:none;opacity:0;transition:opacity .12s;z-index:2000;font-size:13px}

  /* modal */
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:2000}
  .modal .card{background:#fff;padding:16px;border-radius:10px;min-width:300px;max-width:420px}
  .modal input, .modal select{width:100%;padding:8px;margin-top:8px;border:1px solid var(--border);border-radius:6px}

  /* small utility */
  .small{font-size:13px;color:var(--muted)}
  .flex{display:flex;gap:8px;align-items:center}
  .divider{height:1px;background:var(--border);margin:8px 0;border-radius:2px}

  /* drag cue */
  .drag-handle{cursor:grab;font-weight:700}

  /* patterns: using background images for stripes/dots */
  .pattern-stripes{background-image:repeating-linear-gradient(135deg, rgba(0,0,0,0.08) 0 6px, transparent 6px 12px)}
  .pattern-dots{background-image:radial-gradient(rgba(0,0,0,0.06) 1px, transparent 1px);background-size:8px 8px}

  /* highlight row during animation */
  .highlight-row{outline:3px solid rgba(13,110,253,0.18);}

  /* responsiveness */
  @media (max-width:900px){ .row{flex-direction:column} }
</style>
</head>
<body>
<div id="tooltip"></div>
<div class="app">
  <h1>Diagrama Hombre-M√°quina ‚Äî Avanzado</h1>

  <div class="row">
    <div class="col" style="flex-basis:320px;max-width:360px">
      <div class="panel">
        <h3>Controles</h3>
        <div class="controls">
          <label class="small">Minutos: <input id="minutos" type="number" value="60" style="width:80px;margin-left:6px"></label>
          <button id="btnGenerar" class="btn-primary">Generar</button>
          <button id="btnAgregarMaquina" class="btn-primary">+ M√°quina</button>
        </div>

        <div class="divider"></div>

        <h4>Crear acci√≥n</h4>
        <div class="controls">
          <input id="nombreAccion" placeholder="Nombre" />
          <input id="duracionAccion" type="number" value="1" style="width:70px" min="1" />
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="colorAccion" type="color" value="#0d6efd" />
          <select id="categoriaAccion">
            <option value="auxiliar">Auxiliar</option>
            <option value="espera">Espera</option>
            <option value="transporte">Transporte</option>
            <option value="ocio">Ocio</option>
          </select>
          <select id="patternAccion" title="Patr√≥n (impresi√≥n B/N)">
            <option value="none">Sin patr√≥n</option>
            <option value="dots">Punteado</option>
          </select>
          <button id="btnCrearAccion" class="btn-primary">Crear</button>
        </div>

        <div id="acciones-disponibles" style="margin-top:12px"></div>

        <div class="divider"></div>

        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnGuardar" class="btn-secondary">üíæ Guardar JSON</button>
          <button id="btnCargar" class="btn-secondary">üìÇ Cargar JSON</button>
          <button id="btnExportPNG" class="btn-secondary">üñºÔ∏è PNG</button>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnUndo" class="btn-secondary">‚Ü∂ Deshacer</button>
          <button id="btnRedo" class="btn-secondary">‚Ü∑ Rehacer</button>
          <button id="btnCopy" class="btn-secondary">Copiar</button>
          <button id="btnPaste" class="btn-secondary">Pegar</button>
          <button id="btnSplit" class="btn-secondary">Dividir</button>
        </div>

        <div style="margin-top:10px">
          <label class="small">Zoom: <input id="zoomRange" type="range" min="50" max="150" value="100"></label>
        </div>

        <div class="divider"></div>

        <div>
          <h4>Compartir / Autosave</h4>
          <div style="display:flex;gap:8px">
            <button id="btnShare" class="btn-secondary">üîó Generar Link</button>
            <button id="btnRestore" class="btn-secondary">‚ôªÔ∏è Restaurar Autosave</button>
            <button id="btnClear" class="btn-danger">üóëÔ∏è Borrar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="panel">
        <h3>Tabla</h3>
        <div class="tabla-contenedor" id="tablaWrapper" style="height:480px;overflow:auto">
          <table id="tabla-actividades">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="margin-top:8px" class="small">Nota: haz click en el centro de un bloque para editar solo ese bloque. Arrastra por su t√≠tulo para moverlo.</div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3>An√°lisis</h3>
        <div id="analisis-container"></div>
        <canvas id="chartCanvas" width="300" height="200" style="display:block;margin-top:8px;border:1px solid var(--border)"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="modalEditar">
  <div class="card">
    <h3>Editar bloque</h3>
    <div class="small">Editar solo el bloque seleccionado</div>
    <input id="modalNombre" placeholder="Nombre" />
    <input id="modalDuracion" type="number" min="1" placeholder="Duraci√≥n (min)" />
    <input id="modalColor" type="color" />
    <select id="modalCategoria">
      <option value="auxiliar">Auxiliar</option>
      <option value="espera">Espera</option>
      <option value="transporte">Transporte</option>
      <option value="ocio">Ocio</option>
    </select>
    <select id="modalPattern">
      <option value="none">Sin patr√≥n</option>
      <option value="dots">Puntos</option>
    </select>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="modalGuardar" class="btn-primary">Guardar</button>
      <button id="modalCancelar" class="btn-danger">Cancelar</button>
      <button id="modalBorrar" class="btn-secondary">Borrar bloque</button>
    </div>
  </div>
</div>

<input id="fileInput" type="file" accept=".json" style="display:none">

<script>
/* --------------------------
  Estado y utilidades
---------------------------*/
const tabla = document.getElementById('tabla-actividades');
const thead = tabla.querySelector('thead');
const tbody = tabla.querySelector('tbody');
const minutosInput = document.getElementById('minutos');
const btnGenerar = document.getElementById('btnGenerar');
const btnAgregarMaquina = document.getElementById('btnAgregarMaquina');
const accionesDiv = document.getElementById('acciones-disponibles');
const btnCrearAccion = document.getElementById('btnCrearAccion');
const inputNombreAccion = document.getElementById('nombreAccion');
const inputDuracionAccion = document.getElementById('duracionAccion');
const inputColorAccion = document.getElementById('colorAccion');
const categoriaAccion = document.getElementById('categoriaAccion');
const patternAccion = document.getElementById('patternAccion');

const btnGuardar = document.getElementById('btnGuardar');
const btnCargar = document.getElementById('btnCargar');
const fileInput = document.getElementById('fileInput');
const btnExportPNG = document.getElementById('btnExportPNG');

const btnUndo = document.getElementById('btnUndo');
const btnRedo = document.getElementById('btnRedo');
const btnCopy = document.getElementById('btnCopy');
const btnPaste = document.getElementById('btnPaste');
const btnSplit = document.getElementById('btnSplit');

const zoomRange = document.getElementById('zoomRange');
const btnShare = document.getElementById('btnShare');
const btnRestore = document.getElementById('btnRestore');
const btnClear = document.getElementById('btnClear');

const modal = document.getElementById('modalEditar');
const modalNombre = document.getElementById('modalNombre');
const modalDuracion = document.getElementById('modalDuracion');
const modalColor = document.getElementById('modalColor');
const modalCategoria = document.getElementById('modalCategoria');
const modalPattern = document.getElementById('modalPattern');
const modalGuardar = document.getElementById('modalGuardar');
const modalCancelar = document.getElementById('modalCancelar');
const modalBorrar = document.getElementById('modalBorrar');

const tooltip = document.getElementById('tooltip');
const analisisContainer = document.getElementById('analisis-container');
const chartCanvas = document.getElementById('chartCanvas');

let columnas = ['Hombre']; // inicialmente
let acciones = []; // lista de acciones definidas: {nombre,duracion,color,categoria,pattern}
let accionActual = null;
let modoEliminar = false;

let historyStack = [];
let redoStack = [];
const HISTORY_LIMIT = 60;

let clipboardBlock = null; // datos para copiar/pegar
let dragging = null; // {blockId, offsetRow, colIndex}

/* ---------- helpers ---------- */
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8) }
function saveHistory(){
  const snapshot = getState();
  historyStack.push(JSON.stringify(snapshot));
  if(historyStack.length>HISTORY_LIMIT) historyStack.shift();
  redoStack = []; // clear redo
  localStorage.setItem('autoSave', JSON.stringify(snapshot));
}
function undo(){ if(historyStack.length<=1) return; const cur = historyStack.pop(); redoStack.push(cur); const prev = JSON.parse(historyStack[historyStack.length-1]); loadState(prev, true) }
function redo(){ if(redoStack.length===0) return; const state = JSON.parse(redoStack.pop()); historyStack.push(JSON.stringify(state)); loadState(state, true) }

function getContrastingTextColor(hex){
  if(!hex) return 'white';
  if(hex.startsWith('#')) hex = hex.slice(1);
  const r=parseInt(hex.substr(0,2),16);
  const g=parseInt(hex.substr(2,2),16);
  const b=parseInt(hex.substr(4,2),16);
  const yiq = (r*299 + g*587 + b*114)/1000;
  return yiq>=128 ? 'black' : 'white';
}

/* ---------- tabla: generar y repoblar ---------- */
function generarTabla(){
  thead.innerHTML=''; tbody.innerHTML='';
  const minutos = parseInt(minutosInput.value)||0;
  if(minutos<=0) return;
  const trHead = document.createElement('tr');
  trHead.innerHTML = `<th>Minuto</th>` + columnas.map(c=>`<th>${c}</th>`).join('');
  thead.appendChild(trHead);
  for(let i=1;i<=minutos;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i}</td>` + columnas.map(()=>`<td class="celda-inactiva"></td>`).join('');
    tbody.appendChild(tr);
  }
  aplicarBordes();
  actualizarAnalisis();
  saveHistory();
}

/* ---------- UI acciones (lista) ---------- */
function renderAcciones(){
  accionesDiv.innerHTML='';
  acciones.forEach((acc, idx)=>{
    const wrapper = document.createElement('div');
    wrapper.className = 'accion-wrapper';

    const btn = document.createElement('button');
    btn.className = 'btn-secondary';
    btn.style.background = acc.color;
    btn.style.border = '2px solid transparent';
    btn.style.color = getContrastingTextColor(acc.color);
    btn.textContent = `${acc.nombre} (${acc.duracion}m)`;
    btn.title = `Categor√≠a: ${acc.categoria} ¬∑ Patr√≥n: ${acc.pattern}`;
    btn.onclick = ()=>{ accionActual = acc; Array.from(accionesDiv.querySelectorAll('.btn-secondary')).forEach(b=>b.style.borderColor='transparent'); btn.style.borderColor='#000' }
    btn.ondblclick = ()=>{
      const nuevo = prompt('Editar nombre acci√≥n (global):', acc.nombre);
      if(nuevo){ acc.nombre = nuevo; renderAcciones(); }
    }
    
    const deleteBtn = document.createElement('div');
    deleteBtn.className = 'btn-delete-action';
    deleteBtn.textContent = '√ó';
    deleteBtn.title = 'Borrar esta acci√≥n';
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      if (confirm(`¬øSeguro que quieres borrar la acci√≥n "${acc.nombre}"? Esto la eliminar√° de todo el diagrama.`)) {
        // Eliminar instancias en la tabla
        document.querySelectorAll(`td[data-accion="${acc.nombre}"]`).forEach(td => {
          limpiarCelda(td); // Limpia el bloque entero
        });
        
        // Eliminar de la lista de acciones
        acciones.splice(idx, 1);
        renderAcciones();
        saveHistory();
      }
    };
    
    wrapper.appendChild(btn);
    wrapper.appendChild(deleteBtn);
    accionesDiv.appendChild(wrapper);
  });
}

/* ---------- pintar bloque (usa blockId) ---------- */
function pintarBloque(startRowIndex, colIndex, acc){
  const filas = Array.from(tbody.rows);
  const dur = acc.duracion || 1;
  const middle = Math.floor((dur-1)/2);
  const blockId = uid();
  for(let i=0;i<dur;i++){
    const r = startRowIndex + i;
    if(r>=filas.length) break;
    const td = filas[r].cells[colIndex];
    td.className = ''; // limpia inactiva
    // color y pattern
    td.style.background = acc.color;
    td.style.color = getContrastingTextColor(acc.color);
    if(acc.pattern === 'stripes') td.classList.add('pattern-stripes'); else td.classList.remove('pattern-stripes');
    if(acc.pattern === 'dots') td.classList.add('pattern-dots'); else td.classList.remove('pattern-dots');

    td.dataset.accion = acc.nombre;
    td.dataset.blockId = blockId;
    td.dataset.cat = acc.categoria;
    td.dataset.color = acc.color;
    td.dataset.pattern = acc.pattern || 'none';
    td.textContent = (i===middle) ? acc.nombre : '';
    // add drag handle indicator on middle cell (visual cue)
    if(i===middle){
      td.classList.add('drag-handle'); // used for dragging
    }
  }
  aplicarBordes();
  actualizarAnalisis();
  saveHistory();
}

/* ---------- limpiar bloque por celda ---------- */
function limpiarCelda(celda){
  // if part of a block, remove all cells with same blockId
  if(celda.dataset.blockId){
    const bid = celda.dataset.blockId;
    document.querySelectorAll(`td[data-block-id="${bid}"]`).forEach(c=>{
      c.className='celda-inactiva';
      c.style.background=''; c.style.color=''; c.textContent=''; c.removeAttribute('data-accion'); c.removeAttribute('data-block-id'); c.removeAttribute('data-cat'); c.removeAttribute('data-pattern'); c.removeAttribute('data-color'); c.classList.remove('pattern-stripes','pattern-dots','drag-handle');
    });
  } else {
    celda.className='celda-inactiva';
    celda.style.background=''; celda.style.color=''; celda.textContent=''; celda.removeAttribute('data-accion');
  }
  aplicarBordes();
  actualizarAnalisis();
  // No guardar historial aqu√≠ para evitar duplicados, la funci√≥n que llama a limpiarCelda lo har√°.
}

/* ---------- aplicar bordes externos √∫nicos por bloque ---------- */
function aplicarBordes(){
  // reset borders a standard
  const rows = Array.from(tbody.rows);
  rows.forEach(r=>{
    Array.from(r.cells).forEach(td=>{
      td.style.border = `1px solid ${getComputedStyle(document.documentElement).getPropertyValue('--border') || '#dee2e6'}`;
    });
  });

  // agrupar por blockId
  const bloques = {};
  document.querySelectorAll('td[data-block-id]').forEach(td=>{
    const id = td.dataset.blockId;
    if(!bloques[id]) bloques[id] = [];
    bloques[id].push(td);
  });

  Object.values(bloques).forEach(celdas=>{
    // ordenar por fila index para saber first/last
    celdas.sort((a,b)=>a.parentElement.rowIndex - b.parentElement.rowIndex);
    const first = celdas[0], last = celdas[celdas.length-1];
    // establecer bordes exteriores: left/right thick, top on first, bottom on last. quitar bordes superiores/inferiores internas
    celdas.forEach(td=>{
      td.style.borderLeft = '2px solid black';
      td.style.borderRight = '2px solid black';
      td.style.borderTop = 'none';
      td.style.borderBottom = 'none';
    });
    first.style.borderTop = '2px solid black';
    last.style.borderBottom = '2px solid black';
    // ensure corners look good: leave left/right of neighbors with normal borders for adjacent blocks
  });
}

/* ---------- eventos tabla: click, hover, drag ---------- */
tabla.addEventListener('click', (ev)=>{
  const td = ev.target;
  if(td.tagName !== 'TD') return;
  if(td.cellIndex===0) return; // no operar columna minutos

  // si clic en un bloque -> abrir modal para editar SOLO ese bloque
  if(td.dataset.blockId){
    const bid = td.dataset.blockId;
    openModalForBlock(bid);
    return;
  }

  // si no hay accion actual -> alerta
  if(!accionActual){ alert('Selecciona una acci√≥n en "Acciones disponibles"'); return; }

  // pintar a partir de la fila clicada
  const rowIndex = td.parentElement.rowIndex; // rowIndex incluye thead rows, pero tbody rows start at 1? We use DOM order (works)
  // convert visualizar index to tbody index:
  const filaIndex = Array.from(tbody.rows).indexOf(td.parentElement);
  if(filaIndex<0) return;
  pintarBloque(filaIndex, td.cellIndex, accionActual);
});

// mouseover tooltip
tabla.addEventListener('mousemove', (e)=>{
  const el = e.target;
  if(el.tagName==='TD' && el.dataset.accion){
    tooltip.style.left = (e.pageX+12)+'px';
    tooltip.style.top = (e.pageY+12)+'px';
    tooltip.innerHTML = `<b>${el.dataset.accion}</b><br>${el.dataset.cat||''} ¬∑ inicio fila ${el.parentElement.rowIndex}`;
    tooltip.style.opacity = 1;
  } else {
    tooltip.style.opacity = 0;
  }
});

// drag & drop: begin when mousedown on .drag-handle cell (middle)
let dragState = null;
tabla.addEventListener('mousedown', (e)=>{
  const td = e.target;
  if(td.tagName==='TD' && td.classList.contains('drag-handle') && td.dataset.blockId){
    const bid = td.dataset.blockId;
    const colIndex = td.cellIndex;
    const filas = Array.from(tbody.rows);
    // compute top row index of the block
    const blockCells = Array.from(document.querySelectorAll(`td[data-block-id="${bid}"]`));
    const topRow = Math.min(...blockCells.map(c=>c.parentElement.rowIndex));
    // convert to tbody index
    const topIndex = Array.from(tbody.rows).indexOf(blockCells[0].parentElement);
    dragState = { bid, colIndex, topIndex, offsetY: e.clientY, blockCells };
    document.body.style.cursor = 'grabbing';
  }
});
document.addEventListener('mouseup',(e)=>{
  if(dragState){
    // determine release target by finding row under mouse
    const y = e.clientY;
    //

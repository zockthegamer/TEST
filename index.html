<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Diagrama de Procesos de Alta Precisi√≥n</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --muted:#6c757d;
    --accent:#0d6efd; --danger:#dc3545; --success:#198754; --warning: #ffc107;
    --border:#dee2e6;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:#222}
  .app{max-width:1600px;margin:18px auto;padding:18px;background:var(--card);border-radius:10px;box-shadow:0 4px 22px rgba(0,0,0,0.06)}
  h1{margin:0 0 12px}
  .row{display:flex;gap:12px;align-items:flex-start}
  .col{flex:1}
  .panel{background:#fff;border:1px solid var(--border);padding:12px;border-radius:8px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  input,select,button{font-size:14px}
  button{cursor:pointer;padding:8px 10px;border-radius:6px;border:none;color:#fff}
  .btn-primary{background:var(--accent)}
  .btn-danger{background:var(--danger)}
  .btn-success{background:var(--success)}
  .btn-warning{background:var(--warning); color: #000;}
  .btn-secondary{background:var(--muted); color:#fff}
  #acciones-disponibles{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .accion-wrapper{position:relative;display:inline-block;}
  .btn-delete-action{
    position:absolute; top:-8px; right:-8px; background:var(--danger); color:white;
    border-radius:50%; width:18px; height:18px; font-size:12px; line-height:18px;
    text-align:center; cursor:pointer; border:1px solid white;
  }
  .tabla-contenedor{overflow:auto;border:1px solid var(--border);border-radius:6px;margin-top:12px;position:relative}
  table{border-collapse:collapse;width:100%;transform-origin:top left}
  thead th{position:sticky;top:0;background:#f1f3f5;padding:8px;border:1px solid var(--border); cursor:pointer;}
  td,th{min-width:72px; padding: 2px 6px; height: 18px; text-align:center;border:1px solid var(--border); font-size: 12px;}
  tbody td:first-child{background:#fafafa;font-weight:600; min-width: 50px;}
  tbody.modo-seleccion-ciclo td:first-child { cursor: pointer; background-color: #fffbe6 !important; }
  .fila-ciclo { background-color: rgba(25,135,84,0.07); }
  .celda-inactiva{background-image:repeating-linear-gradient(45deg, rgba(220,53,69,0.04), rgba(220,53,69,0.04) 5px, transparent 5px, transparent 10px)}

  #tooltip{position:fixed;background:#222;color:#fff;padding:6px 8px;border-radius:6px;pointer-events:none;opacity:0;transition:opacity .12s;z-index:2000;font-size:13px}
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:2000; overflow-y: auto;}
  .modal .card{background:#fff;padding:16px;border-radius:10px;min-width:300px;max-width:480px; margin: 20px;}
  .modal input{width:100%;padding:8px;margin-top:4px;border:1px solid var(--border);border-radius:6px; box-sizing: border-box;}
  
  .small{font-size:13px;color:var(--muted)}
  .flex{display:flex;gap:8px;align-items:center}
  .divider{height:1px;background:var(--border);margin:12px 0;border-radius:2px}
  .drag-handle{cursor:grab;font-weight:700}
  @media (max-width:900px){ .row{flex-direction:column} }
</style>
</head>
<body>
<div id="tooltip"></div>
<div class="app">
  <h1>Diagrama de Procesos de Alta Precisi√≥n</h1>

  <div class="row">
    <div class="col" style="flex-basis:320px;max-width:360px">
      <div class="panel">
        <h3>Controles Principales</h3>
        <div class="controls">
          <label class="small">Duraci√≥n Gr√°fico (min): <input id="minutos" type="number" value="10" style="width:80px;margin-left:6px"></label>
          <button id="btnGenerar" class="btn-primary">Generar Tabla</button>
        </div>
        <div class="controls" style="margin-top:8px">
            <button id="btnAgregarOperario" class="btn-primary">+ Operario</button>
            <button id="btnAgregarMaquina" class="btn-primary">+ M√°quina</button>
        </div>
        
        <div class="divider"></div>

        <h4>Crear Acci√≥n</h4>
        <div class="controls">
          <input id="nombreAccion" placeholder="Nombre de la acci√≥n" />
          <input id="duracionAccion" type="number" value="0.5" step="0.01" style="width:70px" min="0.01" placeholder="ej. 1.25"/>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="colorAccion" type="color" value="#0d6efd" />
          <button id="btnCrearAccion" class="btn-primary">Crear</button>
        </div>
        <div id="acciones-disponibles" style="margin-top:12px"></div>

        <div class="divider"></div>

        <h4>An√°lisis de Ciclo</h4>
        <div class="controls">
            <button id="btnConfigurarCostos" class="btn-secondary">‚öôÔ∏è Configurar Costos</button>
            <button id="btnDefinirCiclo" class="btn-warning">Definir Rango de Ciclo</button>
        </div>
        <div class="small" style="margin-top:4px;">Haz clic en el bot√≥n y luego selecciona las filas de inicio y fin en la tabla.</div>

        <div class="divider"></div>

        <h4>Herramientas</h4>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnUndo" class="btn-secondary">‚Ü∂ Deshacer</button>
          <button id="btnRedo" class="btn-secondary">‚Ü∑ Rehacer</button>
          <button id="btnCopy" class="btn-secondary">Copiar</button>
          <button id="btnPaste" class="btn-secondary">Pegar</button>
        </div>

        <div class="divider"></div>
        
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnGuardar" class="btn-secondary">üíæ Guardar JSON</button>
          <button id="btnCargar" class="btn-secondary">üìÇ Cargar JSON</button>
          <button id="btnExportPNG" class="btn-secondary">üñºÔ∏è PNG</button>
          <button id="btnShare" class="btn-secondary">üîó Generar Link</button>
        </div>

        <div class="divider"></div>

        <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnRestore" class="btn-secondary">‚ôªÔ∏è Restaurar Autosave</button>
            <button id="btnClear" class="btn-danger">üóëÔ∏è Borrar Todo</button>
        </div>
        <div style="margin-top:10px">
            <label class="small">Zoom: <input id="zoomRange" type="range" min="50" max="150" value="100"></label>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="panel">
        <h3>Diagrama</h3>
        <div class="tabla-contenedor" id="tablaWrapper" style="height:70vh;overflow:auto">
          <table id="tabla-actividades">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3>An√°lisis</h3>
        <div id="analisis-general-container"></div>
        <div class="divider"></div>
        <h4>An√°lisis de Ciclo por Unidad</h4>
        <div id="analisis-ciclo-container">Define un rango de ciclo para ver los c√°lculos.</div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="modalEditar">
  <div class="card">
    <h3>Editar bloque</h3>
    <input id="modalNombre" placeholder="Nombre" />
    <input id="modalDuracion" type="number" step="0.01" min="0.01" placeholder="Duraci√≥n (min)" />
    <input id="modalColor" type="color" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="modalGuardar" class="btn-primary">Guardar</button>
      <button id="modalCancelar" class="btn-danger">Cancelar</button>
      <button id="modalBorrar" class="btn-secondary">Borrar bloque</button>
    </div>
  </div>
</div>

<div class="modal" id="modalCostos">
    <div class="card">
      <h3>Configuraci√≥n de Costos</h3>
      <div class="small">Introduce las tarifas por hora. Los c√°lculos se actualizar√°n al definir un ciclo.</div>
      <div id="costos-form-container" style="margin-top:10px;"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="costosGuardar" class="btn-primary">Guardar Costos</button>
        <button id="costosCancelar" class="btn-danger">Cancelar</button>
      </div>
    </div>
</div>

<input id="fileInput" type="file" accept=".json" style="display:none">

<script>
/* JS: El motor ahora funciona en SEGUNDOS */
/* --------------------------
  ESTADO Y VARIABLES GLOBALES
---------------------------*/
const tabla = document.getElementById('tabla-actividades');
const thead = tabla.querySelector('thead');
const tbody = tabla.querySelector('tbody');
const minutosInput = document.getElementById('minutos');
const btnGenerar = document.getElementById('btnGenerar');
const btnAgregarOperario = document.getElementById('btnAgregarOperario');
const btnAgregarMaquina = document.getElementById('btnAgregarMaquina');
const accionesDiv = document.getElementById('acciones-disponibles');
const btnCrearAccion = document.getElementById('btnCrearAccion');
const inputNombreAccion = document.getElementById('nombreAccion');
const inputDuracionAccion = document.getElementById('duracionAccion');
const inputColorAccion = document.getElementById('colorAccion');
const btnConfigurarCostos = document.getElementById('btnConfigurarCostos');
const btnDefinirCiclo = document.getElementById('btnDefinirCiclo');
const btnGuardar = document.getElementById('btnGuardar'); const btnCargar = document.getElementById('btnCargar'); const fileInput = document.getElementById('fileInput'); const btnExportPNG = document.getElementById('btnExportPNG'); const btnUndo = document.getElementById('btnUndo'); const btnRedo = document.getElementById('btnRedo'); const btnCopy = document.getElementById('btnCopy'); const btnPaste = document.getElementById('btnPaste'); const zoomRange = document.getElementById('zoomRange'); const btnShare = document.getElementById('btnShare'); const btnRestore = document.getElementById('btnRestore'); const btnClear = document.getElementById('btnClear'); const modal = document.getElementById('modalEditar'); const modalNombre = document.getElementById('modalNombre'); const modalDuracion = document.getElementById('modalDuracion'); const modalColor = document.getElementById('modalColor'); const modalGuardar = document.getElementById('modalGuardar'); const modalCancelar = document.getElementById('modalCancelar'); const modalBorrar = document.getElementById('modalBorrar'); const modalCostos = document.getElementById('modalCostos'); const costosFormContainer = document.getElementById('costos-form-container'); const costosGuardar = document.getElementById('costosGuardar'); const costosCancelar = document.getElementById('costosCancelar'); const tooltip = document.getElementById('tooltip'); const analisisGeneralContainer = document.getElementById('analisis-general-container'); const analisisCicloContainer = document.getElementById('analisis-ciclo-container');

// Datos de la aplicaci√≥n
let primerEncabezado = 'Tiempo';
let columnas = [];
let acciones = []; 
let costos = {};
let accionActual = null;
let modoSeleccionRangoCiclo = false;
let cicloInicio = null;
let cicloFin = null;
let proximoClickDefine = 'inicio';
let historyStack = [];
let redoStack = [];
const HISTORY_LIMIT = 60;
let clipboardBlock = null;
let dragState = null;
let lastClickedBlockId = null;
let lastSelectedCell = null;

/* --------------------------
  FUNCIONES AUXILIARES (HELPERS)
---------------------------*/
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8) }
function getContrastingTextColor(hex){ if(!hex) return 'white'; if(hex.startsWith('#')) hex = hex.slice(1); const r=parseInt(hex.substr(0,2),16), g=parseInt(hex.substr(2,2),16), b=parseInt(hex.substr(4,2),16); const yiq = (r*299 + g*587 + b*114)/1000; return yiq>=128 ? 'black' : 'white'; }

/* --------------------------
  GESTI√ìN DEL HISTORIAL Y ESTADO
---------------------------*/
function saveHistory(){ const snapshot = getState(); historyStack.push(JSON.stringify(snapshot)); if(historyStack.length>HISTORY_LIMIT) historyStack.shift(); redoStack = []; localStorage.setItem('autoSave', JSON.stringify(snapshot)); }
function undo(){ if(historyStack.length<=1) return; const cur = historyStack.pop(); redoStack.push(cur); const prev = JSON.parse(historyStack[historyStack.length-1]); loadState(prev, true); }
function redo(){ if(redoStack.length===0) return; const state = JSON.parse(redoStack.pop()); historyStack.push(JSON.stringify(state)); loadState(state, true); }
function getState(){ const tablaData = Array.from(tbody.rows).map(tr=> Array.from(tr.cells).slice(1).map(td=>{ return td.dataset.blockId ? {blockId: td.dataset.blockId, accion: td.dataset.accion, color: td.dataset.color} : null; })); return { primerEncabezado, columnas, acciones, costos, cicloInicio, cicloFin, minutos: parseFloat(minutosInput.value)||0, tablaData }; }
function loadState(state, skipHistory=false){
  if(!state) return;
  primerEncabezado = state.primerEncabezado || 'Tiempo';
  columnas = state.columnas || [{id: `col_${uid()}`, nombre: 'Operario 1', tipo: 'operario'}];
  acciones = state.acciones || [];
  costos = state.costos || {};
  cicloInicio = state.cicloInicio || null;
  cicloFin = state.cicloFin || null;
  minutosInput.value = state.minutos || 10;
  
  generarTabla(true); 

  if(state.tablaData){
    const rows = Array.from(tbody.rows);
    state.tablaData.forEach((filaData, rIdx)=>{
      if (filaData) {
        filaData.forEach((cellData, cIdx)=>{
          if(cellData && rows[rIdx] && rows[rIdx].cells[cIdx+1]){
            const td = rows[rIdx].cells[cIdx+1];
            td.className=''; td.style.background = cellData.color || '#fff'; td.style.color = getContrastingTextColor(cellData.color||'#fff');
            td.dataset.accion = cellData.accion; td.dataset.blockId = cellData.blockId || uid(); td.dataset.color = cellData.color || '';
          }
        });
      }
    });
    const groups = {};
    tbody.querySelectorAll('td[data-block-id]').forEach(td=>{ const id = td.dataset.blockId; if(!groups[id]) groups[id]=[]; groups[id].push(td); });
    Object.values(groups).forEach(g=>{ g.sort((a,b)=>a.parentElement.rowIndex - b.parentElement.rowIndex); const mid = Math.floor((g.length-1)/2); g.forEach((c,i)=> { c.textContent = (i===mid)? c.dataset.accion : ''; if (i===mid) c.classList.add('drag-handle'); }); });
  }
  renderAcciones();
  aplicarBordes();
  actualizarAnalisisGeneral();
  actualizarAnalisisCiclo();
  if(!skipHistory) saveHistory();
}

/* --------------------------
  L√ìGICA DE LA TABLA Y BLOQUES
---------------------------*/
function generarTabla(isLoadingState = false){
  thead.innerHTML=''; tbody.innerHTML='';
  const totalMinutos = parseFloat(minutosInput.value) || 0;
  const totalSegundos = Math.round(totalMinutos * 60);
  if(totalSegundos <= 0) return;

  const trHead = document.createElement('tr');
  trHead.innerHTML = `<th>${primerEncabezado}</th>` + columnas.map(c=>`<th>${c.nombre}</th>`).join('');
  thead.appendChild(trHead);

  for(let i = 0; i < totalSegundos; i++){
      const tr = document.createElement('tr');
      let label = '&nbsp;';
      if (i % 60 === 0) {
          label = `<b>${i/60} min</b>`;
      } else if (i % 15 === 0) {
          label = `:${i % 60}s`;
      }
      tr.innerHTML = `<td>${label}</td>` + columnas.map(()=>`<td class="celda-inactiva"></td>`).join('');
      tbody.appendChild(tr);
  }
  aplicarBordes();
  actualizarAnalisisGeneral();
  actualizarAnalisisCiclo();
  if (!isLoadingState) { saveHistory(); }
}

function pintarBloque(startRowIndex, colIndex, acc){
  const filas = Array.from(tbody.rows);
  const duracionEnSegundos = Math.round(acc.duracion * 60);
  const middle = Math.floor((duracionEnSegundos-1)/2);
  const blockId = uid();
  for(let i=0;i<duracionEnSegundos;i++){
    const r = startRowIndex + i;
    if(r>=filas.length) break;
    const td = filas[r].cells[colIndex];
    td.className = ''; td.style.background = acc.color; td.style.color = getContrastingTextColor(acc.color);
    td.dataset.accion = acc.nombre; td.dataset.blockId = blockId; td.dataset.color = acc.color;
    // Poner el nombre solo si el bloque es suficientemente grande
    if (duracionEnSegundos >= 5 && i === middle) {
        td.textContent = acc.nombre;
        td.classList.add('drag-handle');
    } else {
        td.textContent = '';
    }
  }
  aplicarBordes();
  actualizarAnalisisGeneral();
  actualizarAnalisisCiclo();
  saveHistory();
}
function limpiarCelda(celda){
  if(celda.dataset.blockId){
    const bid = celda.dataset.blockId;
    document.querySelectorAll(`td[data-block-id="${bid}"]`).forEach(c=>{
      c.className='celda-inactiva'; c.style.background=''; c.style.color=''; c.textContent=''; 
      c.removeAttribute('data-accion'); c.removeAttribute('data-block-id'); c.removeAttribute('data-color'); 
      c.classList.remove('drag-handle');
    });
  }
  aplicarBordes();
  actualizarAnalisisGeneral();
}
function aplicarBordes(){
  tbody.querySelectorAll('td').forEach(td => td.style.border = `1px solid var(--border)`);
  const bloques = {};
  tbody.querySelectorAll('td[data-block-id]').forEach(td=>{ const id = td.dataset.blockId; if(!bloques[id]) bloques[id] = []; bloques[id].push(td); });
  Object.values(bloques).forEach(celdas=>{
    celdas.sort((a,b)=>a.parentElement.rowIndex - b.parentElement.rowIndex);
    const first = celdas[0], last = celdas[celdas.length-1];
    celdas.forEach(td=>{ td.style.borderLeft = '2px solid black'; td.style.borderRight = '2px solid black'; td.style.borderTop = 'none'; td.style.borderBottom = 'none'; });
    first.style.borderTop = '2px solid black';
    last.style.borderBottom = '2px solid black';
  });
}

/* --------------------------
  L√ìGICA DE AN√ÅLISIS
---------------------------*/
function actualizarAnalisisGeneral(){
  analisisGeneralContainer.innerHTML = '';
  const totalSegundos = Math.round((parseFloat(minutosInput.value) || 0) * 60);
  if (totalSegundos === 0) return;
  
  columnas.forEach((col, idxCol)=>{
    let usedSeconds = 0;
    if(tbody.rows.length > 0 && tbody.rows[0].cells.length > idxCol + 1) {
      for(let r=0;r<tbody.rows.length;r++){
        const td = tbody.rows[r].cells[idxCol+1];
        if(td && td.dataset.blockId) usedSeconds++;
      }
    }
    const p = document.createElement('p');
    p.style.margin = '4px 0';
    p.innerHTML = `<b>${col.nombre}:</b> ${((usedSeconds/totalSegundos)*100 || 0).toFixed(1)}% activo (${(usedSeconds/60).toFixed(2)} min) ‚Äî ocioso ${((totalSegundos - usedSeconds)/60).toFixed(2)} min`;
    analisisGeneralContainer.appendChild(p);
  });
}
function actualizarAnalisisCiclo() {
    tbody.querySelectorAll('.fila-ciclo').forEach(row => row.classList.remove('fila-ciclo'));

    if (cicloInicio === null || cicloFin === null) {
        analisisCicloContainer.innerHTML = 'Define un rango de ciclo para ver los c√°lculos.';
        return;
    }

    for (let i = cicloInicio; i <= cicloFin; i++) { if (tbody.rows[i]) tbody.rows[i].classList.add('fila-ciclo'); }

    let costoTotal = 0;
    const tiempoDeCicloEnSegundos = (cicloFin - cicloInicio + 1);

    for (let i = cicloInicio; i <= cicloFin; i++) {
        if (!tbody.rows[i]) continue;
        for (let j = 0; j < columnas.length; j++) {
            const cell = tbody.rows[i].cells[j + 1];
            const columna = columnas[j];
            const costoHora = costos[columna.id] || {};
            const esOperario = columna.tipo === 'operario';
            const tarifaActiva = esOperario ? (costos.operario_general?.activa || 0) : (costoHora.activa || 0);
            const tarifaOciosa = esOperario ? tarifaActiva : (costoHora.ociosa || 0);
            
            let tarifaPorHora = 0;
            if (cell && cell.dataset.blockId) {
                tarifaPorHora = cell.dataset.accion.toLowerCase().includes('espera') ? tarifaOciosa : tarifaActiva;
            } else {
                tarifaPorHora = tarifaOciosa;
            }
            costoTotal += tarifaPorHora / 3600;
        }
    }

    const produccionPorHora = tiempoDeCicloEnSegundos > 0 ? (3600 / tiempoDeCicloEnSegundos).toFixed(2) : 0;
    
    analisisCicloContainer.innerHTML = `
        <p style="margin:4px 0;"><b>Tiempo de Ciclo:</b> ${(tiempoDeCicloEnSegundos / 60).toFixed(2)} min por unidad</p>
        <p style="margin:4px 0;"><b>Producci√≥n Estimada:</b> ${produccionPorHora} unidades por hora</p>
        <p style="margin:4px 0;"><b>Costo Total por Unidad:</b> S/ ${costoTotal.toFixed(2)}</p>
    `;
}

/* --------------------------
  MANEJO DE EVENTOS Y UI
---------------------------*/
function renderAcciones(){
  accionesDiv.innerHTML='';
  acciones.forEach((acc, idx)=>{
    const wrapper = document.createElement('div'); wrapper.className = 'accion-wrapper';
    const btn = document.createElement('button'); btn.className = 'btn-secondary'; btn.style.background = acc.color; btn.style.border = '2px solid transparent'; btn.style.color = getContrastingTextColor(acc.color); btn.textContent = `${acc.nombre} (${acc.duracion}m)`; btn.onclick = ()=>{ accionActual = acc; Array.from(accionesDiv.querySelectorAll('.btn-secondary')).forEach(b=>b.style.borderColor='transparent'); btn.style.borderColor='#000' }; btn.ondblclick = ()=>{ const nuevo = prompt('Editar nombre acci√≥n (global):', acc.nombre); if(nuevo){ acc.nombre = nuevo; renderAcciones(); } };
    const deleteBtn = document.createElement('div'); deleteBtn.className = 'btn-delete-action'; deleteBtn.textContent = '√ó'; deleteBtn.title = 'Borrar esta acci√≥n'; deleteBtn.onclick = (e) => { e.stopPropagation(); if (confirm(`¬øBorrar acci√≥n "${acc.nombre}"?`)) { document.querySelectorAll(`td[data-accion="${acc.nombre}"]`).forEach(td => limpiarCelda(td)); acciones.splice(idx, 1); renderAcciones(); saveHistory(); } };
    wrapper.appendChild(btn); wrapper.appendChild(deleteBtn); accionesDiv.appendChild(wrapper);
  });
}
btnCrearAccion.onclick = ()=>{ const name = inputNombreAccion.value.trim(); if(!name) return; const dur = parseFloat(inputDuracionAccion.value) || 1; const color = inputColorAccion.value || '#0d6efd'; acciones.push({nombre:name,duracion:dur,color}); renderAcciones(); inputNombreAccion.value=''; inputDuracionAccion.value='0.5'; saveHistory(); };
function agregarColumna(tipo) { const totalDelTipo = columnas.filter(c => c.tipo === tipo).length; const nombre = tipo === 'operario' ? `Operario ${totalDelTipo + 1}` : `M√°quina ${totalDelTipo + 1}`; const nuevaCol = { id: `col_${uid()}`, nombre, tipo }; columnas.push(nuevaCol); generarTabla(); }
btnAgregarOperario.onclick = () => agregarColumna('operario');
btnAgregarMaquina.onclick = () => agregarColumna('maquina');
btnDefinirCiclo.onclick = () => {
    modoSeleccionRangoCiclo = !modoSeleccionRangoCiclo;
    tbody.classList.toggle('modo-seleccion-ciclo', modoSeleccionRangoCiclo);
    if (modoSeleccionRangoCiclo) {
        btnDefinirCiclo.textContent = 'Cancelando Selecci√≥n...'; btnDefinirCiclo.classList.replace('btn-warning', 'btn-danger');
        proximoClickDefine = 'inicio'; cicloInicio = null; cicloFin = null;
        actualizarAnalisisCiclo();
    } else {
        btnDefinirCiclo.textContent = 'Definir Rango de Ciclo'; btnDefinirCiclo.classList.replace('btn-danger', 'btn-warning');
    }
};

tabla.addEventListener('click', (ev)=>{
  const td = ev.target;
  if(td.tagName !== 'TD') return;
  if (modoSeleccionRangoCiclo && td.cellIndex === 0) {
      const rowIndex = Array.from(tbody.rows).indexOf(td.parentElement);
      if (proximoClickDefine === 'inicio') {
          cicloInicio = rowIndex; cicloFin = null; proximoClickDefine = 'fin';
          analisisCicloContainer.innerHTML = `Fila de inicio: ${((cicloInicio)/60).toFixed(2)} min. Selecciona la fila de fin.`;
          actualizarAnalisisCiclo(); tbody.rows[rowIndex].classList.add('fila-ciclo');
      } else {
          cicloFin = rowIndex;
          if (cicloInicio > cicloFin) { [cicloInicio, cicloFin] = [cicloFin, cicloInicio]; }
          proximoClickDefine = 'inicio'; modoSeleccionRangoCiclo = false;
          tbody.classList.remove('modo-seleccion-ciclo');
          btnDefinirCiclo.textContent = 'Definir Rango de Ciclo'; btnDefinirCiclo.classList.replace('btn-danger', 'btn-warning');
          actualizarAnalisisCiclo(); saveHistory();
      }
      return;
  }
  if (td.cellIndex === 0) return;
  if(td.dataset.blockId){ openModalForBlock(td.dataset.blockId); return; }
  if(!accionActual){ alert('Selecciona una acci√≥n'); return; }
  const filaIndex = Array.from(tbody.rows).indexOf(td.parentElement);
  if(filaIndex < 0) return;
  pintarBloque(filaIndex, td.cellIndex, accionActual);
});
tabla.addEventListener('mousedown', (e)=>{ const td = e.target; if(td.tagName==='TD' && td.classList.contains('drag-handle') && td.dataset.blockId){ dragState = { bid: td.dataset.blockId, startY: e.clientY, hasMoved: false }; document.body.style.cursor = 'grabbing'; }});
document.addEventListener('mousemove', (e) => { if (dragState && Math.abs(e.clientY - e.pageY) > 5) { dragState.hasMoved = true; }});
document.addEventListener('mouseup', (e) => {
  if (dragState && dragState.hasMoved) {
    const targetCell = document.elementFromPoint(e.clientX, e.clientY);
    if (targetCell && targetCell.tagName === 'TD' && targetCell.parentElement.parentElement.tagName === 'TBODY' && targetCell.cellIndex > 0) {
      const targetRowIndex = Array.from(tbody.rows).indexOf(targetCell.parentElement);
      const targetColIndex = targetCell.cellIndex;
      const { bid } = dragState;
      const blockCels = Array.from(document.querySelectorAll(`td[data-block-id="${bid}"]`));
      if (blockCels.length > 0) {
        const aName = blockCels[0].dataset.accion;
        const actionObj = acciones.find(a => a.nombre === aName) || { nombre: aName, duracion: (blockCels.length/60), color: blockCels[0].dataset.color };
        blockCels.forEach(c => limpiarCelda(c));
        pintarBloque(targetRowIndex, targetColIndex, actionObj);
      }
    }
  }
  dragState = null;
  document.body.style.cursor = '';
});
thead.addEventListener('click', (e) => { const th = e.target; if (th.tagName !== 'TH' || modoSeleccionRangoCiclo) return; const nuevoNombre = prompt('Editar nombre de la columna:', th.textContent); if (nuevoNombre && nuevoNombre.trim() !== '') { const nombreRecortado = nuevoNombre.trim(); th.textContent = nombreRecortado; if (th.cellIndex === 0) { primerEncabezado = nombreRecortado; } else { columnas[th.cellIndex - 1].nombre = nombreRecortado; actualizarAnalisisGeneral(); } saveHistory(); }});
tabla.addEventListener('mousemove', (e)=>{ const el = e.target; if(el.tagName==='TD' && el.dataset.accion){ tooltip.style.left = (e.pageX+12)+'px'; tooltip.style.top = (e.pageY+12)+'px'; tooltip.innerHTML = `<b>${el.dataset.accion}</b>`; tooltip.style.opacity = 1; } else { tooltip.style.opacity = 0; }});
tabla.addEventListener('click', (e)=>{ const td = e.target; if(td.tagName==='TD'){ lastSelectedCell = td; lastClickedBlockId = td.dataset.blockId || null; }});
document.addEventListener('keydown', (e)=>{ const targetTagName = e.target.tagName.toLowerCase(); if (targetTagName === 'input') return; if(e.key==='Delete' || e.key === 'Backspace'){ if(lastClickedBlockId){ document.querySelectorAll(`td[data-block-id="${lastClickedBlockId}"]`).forEach(c=>limpiarCelda(c)); actualizarAnalisisCiclo(); saveHistory(); } }});

function openModalForBlock(bid){ editingBlockId = bid; const cells = Array.from(document.querySelectorAll(`td[data-block-id="${bid}"]`)); if(!cells.length) return; const midCell = cells[Math.floor(cells.length/2)]; modalNombre.value = midCell.dataset.accion || ''; modalColor.value = midCell.dataset.color || '#0d6efd'; modalDuracion.value = (cells.length / 60).toFixed(2); modal.style.display = 'flex'; modalNombre.focus(); }
modalCancelar.onclick = ()=>{ modal.style.display='none'; editingBlockId=null }
modalGuardar.onclick = ()=>{ const nuevoNombre = modalNombre.value.trim(); if(!editingBlockId){ modal.style.display='none'; return; } const cells = Array.from(document.querySelectorAll(`td[data-block-id="${editingBlockId}"]`)); if(!cells.length){ modal.style.display='none'; editingBlockId=null; return; } const nuevaDuracion = parseFloat(modalDuracion.value) || (cells.length / 60); const nuevoColor = modalColor.value; const startIndex = Array.from(tbody.rows).indexOf(cells[0].parentElement); const colIndex = cells[0].cellIndex; cells.forEach(c => limpiarCelda(c)); const actionName = nuevoNombre || 'Accion'; const actionObj = acciones.find(a=>a.nombre===actionName); let accObj; if(actionObj){ actionObj.color = nuevoColor; actionObj.duracion = nuevaDuracion; accObj = actionObj; } else { accObj = {nombre:actionName, duracion:nuevaDuracion, color:nuevoColor}; acciones.push(accObj); renderAcciones(); } pintarBloque(startIndex, colIndex, accObj); modal.style.display='none'; editingBlockId=null; };
modalBorrar.onclick = ()=>{ if(!editingBlockId || !confirm('¬øBorrar este bloque?')) return; document.querySelectorAll(`td[data-block-id="${editingBlockId}"]`).forEach(c => limpiarCelda(c)); actualizarAnalisisCiclo(); modal.style.display='none'; editingBlockId=null; saveHistory(); }
btnConfigurarCostos.onclick = () => { costosFormContainer.innerHTML = ''; const tieneOperarios = columnas.some(c => c.tipo === 'operario'); if (tieneOperarios) { costosFormContainer.innerHTML += `<label class="small">Costo/hr General de Operarios (S/)</label><input type="number" data-col-id="operario_general" value="${costos.operario_general?.activa || ''}">`; } columnas.filter(c => c.tipo === 'maquina').forEach(col => { costosFormContainer.innerHTML += `<div class="divider"></div><label class="small"><b>${col.nombre}</b> Costo/hr Activa (S/)</label><input type="number" data-col-id="${col.id}" data-costo-tipo="activa" value="${costos[col.id]?.activa || ''}"><label class="small">${col.nombre} Costo/hr Ociosa (S/)</label><input type="number" data-col-id="${col.id}" data-costo-tipo="ociosa" value="${costos[col.id]?.ociosa || ''}">`; }); modalCostos.style.display = 'flex'; };
costosGuardar.onclick = () => { costosFormContainer.querySelectorAll('input').forEach(input => { const colId = input.dataset.colId; const costoTipo = input.dataset.costoTipo || 'activa'; if (!costos[colId]) costos[colId] = {}; costos[colId][costoTipo] = parseFloat(input.value) || 0; }); if (costos.operario_general) { columnas.filter(c => c.tipo === 'operario').forEach(op => { if (!costos[op.id]) costos[op.id] = {}; costos[op.id].activa = costos.operario_general.activa; }); } modalCostos.style.display = 'none'; actualizarAnalisisCiclo(); saveHistory(); };
costosCancelar.onclick = () => { modalCostos.style.display = 'none'; };
btnUndo.onclick = ()=>undo(); btnRedo.onclick = ()=>redo();
btnCopy.onclick = ()=>{ if(lastClickedBlockId){ clipboardBlock = captureBlock(lastClickedBlockId); alert('Bloque copiado.'); } else alert('Haz click en un bloque para copiarlo.'); };
btnPaste.onclick = ()=>{ if(!clipboardBlock) return alert('No hay nada en el portapapeles.'); const target = lastSelectedCell || tbody.rows[0].cells[1]; if(!target) return; const filaIndex = Array.from(tbody.rows).indexOf(target.parentElement); pintarBlockFromData(filaIndex, target.cellIndex, clipboardBlock); saveHistory(); };
function captureBlock(bid){ const cells = Array.from(document.querySelectorAll(`td[data-block-id="${bid}"]`)); if(!cells.length) return null; return { nombre: cells[0].dataset.accion, color: cells[0].dataset.color, duracion: cells.length / 60 }; }
function pintarBlockFromData(startRow, colIndex, data){ const filas = Array.from(tbody.rows); const dur = Math.round(data.duracion * 60); const blockId = uid(); for(let i=0;i<dur;i++){ const r = startRow + i; if(r>=filas.length) break; const td = filas[r].cells[colIndex]; td.className=''; td.style.background = data.color; td.style.color = getContrastingTextColor(data.color); td.dataset.accion = data.nombre; td.dataset.blockId = blockId; td.dataset.color = data.color; if (dur >= 5 && i === Math.floor((dur-1)/2)) td.textContent = data.nombre; } aplicarBordes(); actualizarAnalisisGeneral(); }
btnGuardar.onclick = ()=>{ const state = getState(); const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state,null,2)); const a = document.createElement('a'); a.href = dataStr; a.download = 'diagrama.json'; a.click(); }
btnCargar.onclick = ()=> fileInput.click();
fileInput.onchange = e=>{ const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=> { try{ const state = JSON.parse(reader.result); loadState(state); saveHistory(); }catch(err){ alert('Error al cargar.'); } }; reader.readAsText(f); }
btnExportPNG.onclick = () => { const tablaParaExportar = document.getElementById('tabla-actividades'); tablaParaExportar.style.outline = '2px solid var(--accent)'; html2canvas(tablaParaExportar, { useCORS: true, logging: false, onclone: (doc) => { doc.getElementById('tabla-actividades').style.transform = ''; } }).then(canvas => { const a = document.createElement('a'); a.href = canvas.toDataURL('image/png'); a.download = 'diagrama.png'; a.click(); tablaParaExportar.style.outline = 'none'; }); };
btnShare.onclick = () => { const state = getState(); const jsonString = JSON.stringify(state); const compressed = LZString.compressToEncodedURIComponent(jsonString); const url = location.origin + location.pathname + '#s=' + compressed; prompt('Copia este link corto y comp√°rtelo:', url); }
btnRestore.onclick = ()=>{ const saved = localStorage.getItem('autoSave'); if(!saved) return alert('No hay datos guardados.'); try{ const state = JSON.parse(saved); loadState(state); saveHistory(); }catch(e){ alert('No se pudo restaurar.'); } };
btnClear.onclick = ()=>{ if(confirm('¬øSeguro que quieres borrar todo?')){ primerEncabezado = 'Tiempo'; columnas=[]; acciones=[]; costos={}; cicloInicio=null; cicloFin=null; agregarColumna('operario'); generarTabla(); renderAcciones(); localStorage.removeItem('autoSave'); saveHistory(); } }
zoomRange.oninput = ()=> { tabla.style.transform = `scale(${zoomRange.value/100})`; }
document.addEventListener('keydown', (e)=>{ const targetTagName = e.target.tagName.toLowerCase(); if (targetTagName === 'input') return; if(e.ctrlKey && e.key==='z'){ e.preventDefault(); undo(); } if(e.ctrlKey && e.key==='y'){ e.preventDefault(); redo(); } if(e.ctrlKey && e.key==='c'){ e.preventDefault(); if(lastClickedBlockId) clipboardBlock = captureBlock(lastClickedBlockId); } if(e.ctrlKey && e.key==='v'){ e.preventDefault(); btnPaste.click(); } if(e.key==='Delete' || e.key === 'Backspace'){ if(lastClickedBlockId){ document.querySelectorAll(`td[data-block-id="${lastClickedBlockId}"]`).forEach(c=>limpiarCelda(c)); actualizarAnalisisCiclo(); saveHistory(); } }});

/* --------------------------
  INICIALIZACI√ìN
---------------------------*/
function init() {
  try {
    if (location.hash.startsWith('#s=')) { const compressed = location.hash.replace('#s=', ''); const jsonString = LZString.decompressFromEncodedURIComponent(compressed); const state = JSON.parse(jsonString); loadState(state); return;
    } else if (location.hash.startsWith('#state=')) { const json = decodeURIComponent(location.hash.replace('#state=', '')); const state = JSON.parse(json); loadState(state); return; }
  } catch (e) { console.warn('No se pudo cargar el estado desde el hash.', e); }

  const saved = localStorage.getItem('autoSave');
  if (saved) {
    try { const s = JSON.parse(saved); loadState(s, true); } catch (e) { generarTabla(); }
  } else {
    columnas.push({id: `col_${uid()}`, nombre: 'Operario 1', tipo: 'operario'});
    acciones = [ { nombre: 'Cargar Pieza', duracion: 0.25, color: '#0d6efd' }, { nombre: 'Espera', duracion: 1.5, color: '#ffc107' }, { nombre: 'Descargar Pieza', duracion: 0.2, color: '#0dcaf0' } ];
    renderAcciones();
    generarTabla();
  }
}
init();
window.addEventListener('beforeunload', ()=>{ if(historyStack.length > 0) localStorage.setItem('autoSave', JSON.stringify(getState())); });
</script>
</body>
</html>
